---
title: Gitlab|å®‰è£…-è¿ç§»-åˆ é™¤
tags:
  - gitlab
  - git
  - æ•™ç¨‹
categories:
  - æ•™ç¨‹
abbrlink: 25664
date: 2018-12-10 16:02:11
---
GitLab ç”±ä¹Œå…‹å…°ç¨‹åºå‘˜ Dmitriy Zaporozhets å’Œ Valery Sizov å¼€å‘ï¼Œå®ƒç”± Ruby å†™æˆã€‚åæ¥ï¼Œä¸€äº›éƒ¨åˆ†ç”¨ Go è¯­è¨€é‡å†™ã€‚æˆªæ­¢ 2018 å¹´ 5 æœˆï¼Œè¯¥å…¬å¸çº¦æœ‰ 290 åå›¢é˜Ÿæˆå‘˜ï¼Œä»¥åŠ 2000 å¤šåå¼€æºè´¡çŒ®è€…ã€‚ GitLab è¢« IBMï¼ŒSonyï¼ŒJÃ¼lich Research Centerï¼ŒNASAï¼ŒAlibabaï¼ŒInvinceaï¼ŒOâ€™Reilly Mediaï¼ŒLeibniz-Rechenzentrum (LRZ)ï¼ŒCERNï¼ŒSpaceX ç­‰ç»„ç»‡ä½¿ç”¨ã€‚<!--less-->

# 1 å®‰è£…

## 1.1 Omnibus package installation

è¿™æ˜¯Gitlabå®˜ç½‘æ¨èçš„å®‰è£…æ–¹å¼ã€‚å®˜ç½‘æ–‡æ¡£é“¾æ¥ä½äº[Gitlab Installation](https://gitlab.com/gitlab-org/gitlab-recipes/blob/master/web-server/nginx/gitlab-omnibus-nginx.conf)ã€‚ä¸è¿‡ï¼Œç°åœ¨ç›´æ¥å»å®˜ç½‘é»˜è®¤ç»™å‡ºçš„æ˜¯ä¼ä¸šç‰ˆï¼Œå³gitlab-eeçš„å®‰è£…æ–¹å¼ï¼ˆä»˜è´¹çš„ï¼‰ï¼Œè€Œä¸ªäººç‰ˆå…¶å®ç”¨gitlab-ceå°±å¤Ÿäº†ã€‚gitlab-ceå®‰è£…æ–¹å¼å¦‚ä¸‹

### 1.1.1 å®‰è£…å¹¶é…ç½®ä¾èµ–

```bash
sudo apt-get install -y curl openssh-server ca-certificates 
```

ç„¶åå®‰è£…Postfixæ¥å¯åŠ¨é‚®ä»¶æé†’åŠŸèƒ½ã€‚ï¼ˆå¦‚æœä½ ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹çš„é‚®ä»¶æœåŠ¡ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€æ­¥å¹¶ä¸”å‚ç…§[é…ç½®å¤–éƒ¨SMTPæœåŠ¡å™¨](https://docs.gitlab.com/omnibus/settings/smtp.html)ï¼‰ã€‚

```bash
sudo apt-get install -y postfix
```

åœ¨æ¥ä¸‹æ¥çš„é…ç½®è¿‡ç¨‹ä¸­ï¼Œé€‰æ‹©'Internet Site'é€‰é¡¹ã€‚ä½¿ç”¨ä½ çš„æœåŠ¡å™¨çš„åŸŸåæ¥ä½œä¸º'mail name'ã€‚å¦‚æœè¿˜æœ‰åç»­çš„é€‰é¡¹ï¼Œè¾“å…¥Enterç›´è‡³å®‰è£…å®Œæˆã€‚

### 1.1.2 å®‰è£…Gitlab-EE

æ·»åŠ Gitlab Packageä»“åº“ï¼š

```bash
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash 
```

> æ³¨æ„è¿™é‡Œå®‰è£…çš„æ˜¯CEç‰ˆæœ¬ï¼Œæ•…æ˜¯gitlab-ceï¼Œä¼ä¸šç‰ˆå¯¹åº”çš„æ˜¯gitlab-ee

æ¥ä¸‹æ¥å®‰è£…Gitlabï¼š

```bash
sudo EXTERNAL_URL="http://gitlab.example.com" apt-get install gitlab-ce 
```

è¿™é‡Œçš„EXTERNAL_URLæ˜¯ä½ çš„GitlabæœåŠ¡è¦ä½¿ç”¨çš„åŸŸåã€‚å¦‚æœä½ åªä½¿ç”¨httpï¼Œæˆ–è€…åç»­è¦ä½¿ç”¨å·²æœ‰çš„Nginxï¼Œå¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨httpã€‚å¦‚æœä½¿ç”¨httpsï¼Œgitlabä¼šè°ƒç”¨[Let's encrtpy](https://letsencrypt.org)çš„æœåŠ¡ä¸ºä½ çš„ç½‘ç«™æ·»åŠ sslè¯ä¹¦ã€‚

### 1.1.3 ç™»å½•Gtilab

è¿›å…¥ä½ åœ¨å®‰è£…é˜¶æ®µçš„åŸŸåï¼Œä½ ä¼šè¢«é‡å®šå‘åˆ°å¯†ç é‡ç½®ç•Œé¢ã€‚åœ¨è¿™ä¸ªé¡µé¢ä½ è¦è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·çš„å¯†ç ï¼Œç„¶åå›åˆ°ç™»å½•ç•Œé¢ã€‚åœ¨è¿™ä¸ªç™»å½•ç•Œé¢ï¼Œä½¿ç”¨`root`ç”¨æˆ·åå’Œä¸Šä¸€æ­¥è®¾ç½®çš„å¯†ç ç™»å½•ã€‚

## 1.2 ä½¿ç”¨å·²æœ‰çš„Nginx

è¿™ä¸ªç« èŠ‚æˆ‘ä»¬å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/nginx.md#using-a-non-bundled-web-server)ç»™å‡ºä½¿ç”¨å·²æœ‰çš„Nginxçš„æ–¹æ³•ã€‚

### 1.2.1 ç¦ç”¨Gitlabè‡ªå¸¦çš„Nginx

ç¼–è¾‘`/etc/gitlab/gitlab.rb`æ–‡ä»¶ï¼Œè®¾ç½®

```ruby
nginx['enable'] = false
```

### 1.2.2 è®¾ç½®å¤–éƒ¨æœåŠ¡å™¨çš„ç”¨æˆ·

è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ä¿è¯å¤–éƒ¨æœåŠ¡å™¨ç”¨æˆ·èƒ½å¤Ÿè®¿é—®gitlabã€‚ä½¿ç”¨Nginxæ—¶ï¼Œå¯ä»¥é€šè¿‡`/etc/nginx/nginx.conf`æ–‡ä»¶æŸ¥çœ‹åˆ°nginxç”¨æˆ·ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªç”¨æˆ·åæ˜¯`www-data`ã€‚ä¿®æ”¹`/etc/gitlab/gitlab.rb`ï¼š

```ruby
web_server['external_users'] = ['www-data']
```

ç„¶åä½¿ç”¨`sudo gitlab-ctl reconfigure`æ¥ä½¿å¾—æ›´æ”¹ç”Ÿæ•ˆã€‚

### 1.2.3 Trusted proxies

å¦‚æœä½ çš„åå‘ä»£ç†æœåŠ¡å™¨å’Œgitlabä¸æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œé‚£ä¹ˆä½ è¿˜éœ€è¦è®¾ç½®Trusted proxiesã€‚

```ruby
gitlab_rails['trusted_proxies'] = ['192.168.1.0/24', '192.168.2.1', '2001:0db8::/32']
```

### 1.2.4 Nginxç¤ºä¾‹é…ç½®æ–‡ä»¶

```nginx
# gitlab socket æ–‡ä»¶åœ°å€
upstream gitlab {
  # 7.x ç‰ˆæœ¬åœ¨æ­¤ä½ç½®
  # server unix:/var/opt/gitlab/gitlab-rails/tmp/sockets/gitlab.socket;
  # 8.0 ä½ç½®
  server unix:/var/opt/gitlab/gitlab-rails/sockets/gitlab.socket;
}

server {
  listen *:80;

  server_name gitlab.example.com;   # è¯·ä¿®æ”¹ä¸ºä½ çš„åŸŸå

  server_tokens off;     # don't show the version number, a security best practice
  root /opt/gitlab/embedded/service/gitlab-rails/public;

  # Increase this if you want to upload large attachments
  # Or if you want to accept large git objects over http
  client_max_body_size 250m;

  # individual nginx logs for this gitlab vhost
  access_log  /var/log/gitlab/nginx/gitlab_access.log;
  error_log   /var/log/gitlab/nginx/gitlab_error.log;

  location / {
    # serve static files from defined root folder;.
    # @gitlab is a named location for the upstream fallback, see below
    try_files $uri $uri/index.html $uri.html @gitlab;
  }

  # if a file, which is not found in the root folder is requested,
  # then the proxy pass the request to the upsteam (gitlab unicorn)
  location @gitlab {
    # If you use https make sure you disable gzip compression
    # to be safe against BREACH attack

    proxy_read_timeout 300; # Some requests take more than 30 seconds.
    proxy_connect_timeout 300; # Some requests take more than 30 seconds.
    proxy_redirect     off;

    proxy_set_header   X-Forwarded-Proto https;
    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Frame-Options   SAMEORIGIN;

    proxy_pass http://gitlab;
  }

  # Enable gzip compression as per rails guide: http://guides.rubyonrails.org/asset_pipeline.html#gzip-compression
  # WARNING: If you are using relative urls do remove the block below
  # See config/application.rb under "Relative url support" for the list of
  # other files that need to be changed for relative url support
  location ~ ^/(assets)/  {
    root /opt/gitlab/embedded/service/gitlab-rails/public;
    # gzip_static on; # to serve pre-gzipped version
    expires max;
    add_header Cache-Control public;
  }

  # error_page 502 /502.html;
}
```

# 2 è¿ç§»

## 2.1 å¤‡ä»½

è¿ç§»é¦–å…ˆè¦åšçš„æ˜¯å¤‡ä»½ã€‚åœ¨[gitå­¦ä¹ ------> Gitlabå¦‚ä½•è¿›è¡Œå¤‡ä»½æ¢å¤ä¸è¿ç§»ï¼Ÿ](https://blog.csdn.net/ouyang_peng/article/details/77070977)è¿™ç¯‡æ–‡ç« ä¸­è¯¦ç»†è®²è¿°äº†å¤‡ä»½çš„é—®é¢˜ã€‚æˆ‘ä»¬è¿™é‡Œä»‹ç»çš„æ˜¯æœ€ä¸ºç›´æ¥å’Œç®€å•çš„æ­¥éª¤ã€‚å¦‚æœè¦æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯è¯·é˜…è¯»è¿™ç¯‡å‚è€ƒã€‚

å¤‡ä»½ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

```bash
gitlab-rake gitlab:backup:create
```

å¤‡ä»½ä¼šç”Ÿæˆåœ¨`/var/opt/gitlab/backups`ç›®å½•ä¸‹ã€‚åç§°ç±»ä¼¼äº`1502357536_2017_08_10_9.4.3_gitlab_backup.tar`ã€‚ä¸‹é¢è¿™äº›é…ç½®ä¿¡æ¯ï¼Œæ²¡æœ‰åŒ…å«åœ¨backupæ–‡ä»¶é‡Œé¢ã€‚éœ€è¦æ‰‹åŠ¨è¿ç§»ã€‚

- `/etc/gitlab/gitlab.rb` é…ç½®æ–‡ä»¶é¡»å¤‡ä»½
- `/var/opt/gitlab/nginx/conf` nginxé…ç½®æ–‡ä»¶
- `/etc/postfix/main.cfpostfix` é‚®ä»¶é…ç½®å¤‡ä»½

![å¤‡ä»½å‘½ä»¤çš„æ‰§è¡Œ](https://imgs.codewoody.com/uploads/big/109e8d518cabd20d26bb2bdc01feaaa0.png)

## 2.2 åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…gitlab

è¿ç§»è¿‡ç¨‹ä¸­è¦æ±‚æºæœºå™¨å’Œç›®æ ‡æœºå™¨ä¸Šå®‰è£…çš„gitlabç‰ˆæœ¬æ˜¯ç›¸åŒçš„ã€‚å¦‚æœä¸åŒï¼Œå…¶å®æœ€å¥½çš„åšæ³•æ˜¯å…ˆå°†æºæœºå™¨ä¸Šçš„gitlabå‡çº§åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚ç„¶åå†ç”Ÿæˆå¤‡ä»½ã€‚

![å¦‚ä½•æŸ¥çœ‹Gitlabç‰ˆæœ¬](https://imgs.codewoody.com/uploads/big/fc818b279eb9b922aa4b4adbb8c8ff57.png)

## 2.3 ä¸Šä¼ å¤‡ä»½

ä½¿ç”¨`scp`å‘½ä»¤å°†å¤‡ä»½æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡æœºå™¨çš„`/var/opt/gitlab/backups`ã€‚

> å¦‚æœscpä¸Šä¼ ç›®æ ‡æ–‡ä»¶æ–‡ä»¶å¤¹çš„æƒé™ä¸å¤Ÿï¼Œå¯ä»¥å…ˆä¸Šä¼ åˆ°è‡ªå·±çš„homeç›®å½•ä¸‹ï¼Œç„¶åsshç™»å½•åˆ°æœåŠ¡å™¨ä½¿ç”¨sudoè¿›è¡Œç§»åŠ¨ã€‚

## 2.4 åº”ç”¨å¤‡ä»½æ–‡ä»¶

é¦–å…ˆä¸ºäº†é¿å…æ½œåœ¨çš„æƒé™é—®é¢˜ï¼Œå°†å¤‡ä»½æ–‡ä»¶çš„æƒé™è®¾ç½®ä¸º777

```bash
chmod 777 1502357536_2017_08_10_9.4.3_gitlab_backup.tar 
```

ç„¶ååœæ­¢gitlabçš„ç›¸å…³æ•°æ®è¿æ¥æœåŠ¡

```bash
gitlab-ctl stop unicorn
gitlab-ctl stop sidekiq
```

ç„¶åç”¨ä¸‹é¢çš„å‘½ä»¤è¯»å–å¤‡ä»½ï¼š

```bash
gitlab-rake gitlab:backup:restore BACKUP=1502357536_2017_08_10_9.4.3
```

åœ¨åç»­å‡ºç°çš„æ‰€æœ‰è¯¢é—®ä¸­è¾“å…¥yesï¼Œç­‰å¾…æ‰§è¡Œå®Œæ¯•ï¼Œå³å®Œæˆäº†è¿ç§»è¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥å†æ¬¡å¯åŠ¨gitlab

```bash
sudo gitlab-ctl start
```

# 3 åˆ é™¤

ä¸‹é¢çš„åˆ é™¤è¿‡ç¨‹åœ¨Ubuntu 16ä¸Šå¾—åˆ°éªŒè¯ï¼š

## 3.1 ç§»é™¤gitlabæœåŠ¡

```bash
sudo gitlab-ctl uninstall
```

## 3.2 æ¸…æ¥šGitlabäº§ç”Ÿçš„æ•°æ®

```bash
sudo gitlab-ctl cleanse
```

## 3.3 åˆ é™¤Gitlabç”Ÿæˆçš„ç³»ç»Ÿè´¦æˆ·

```bash
sudo gitlab-ctl remove-accounts
```

## 3.4 åˆ é™¤gitlab

```bash
sudo dpkg -P gitlab-ce
```

## 3.5 å…¶ä»–æ–‡ä»¶çš„åˆ é™¤

é™¤äº†ä¸Šè¿°æ“ä½œï¼ŒGitlabä½¿ç”¨çš„å…¶ä»–æ–‡ä»¶å¤¹è¿˜éœ€è¦æ‰‹åŠ¨åˆ é™¤ï¼ŒåŒ…æ‹¬ï¼š

- `/opt/gitlab`: åŒ…å«äº†Gitlabçš„åº”ç”¨ä»£ç å’Œä¾èµ–
- `/var/opt/gitlab`: åŒ…å«äº†åº”ç”¨çš„æ•°æ®å’Œé…ç½®ä¿¡æ¯(gitlab-ctl reconfigureçš„å†™å…¥å†…å®¹)
- `/etc/gitlab`: omnibus gitlabçš„é…ç½®ä¿¡æ¯ã€‚è¿™é‡Œçš„æ–‡ä»¶æ˜¯å”¯ä¸€å…è®¸ä½ æ‰‹åŠ¨ç¼–è¾‘çš„éƒ¨åˆ†
- `/var/log/gitlab`: æ—¥å¿—æ–‡ä»¶

åœ¨ä½ å®Œæˆäº†å¼€å§‹çš„å››ä¸ªæ­¥éª¤åï¼Œè¿™é‡Œçš„å››ä¸ªæ–‡ä»¶å¤¹å¯ä»¥å®‰å…¨åœ°æ‰‹åŠ¨åˆ é™¤ã€‚
